# 提交代码规范

本文档详细定义了 Web Server 项目的 Git 提交规范，包括提交消息格式、分支管理、工作流程和最佳实践。

## 目录

1. [提交消息格式](#提交消息格式)
2. [提交类型详解](#提交类型详解)
3. [作用域使用指南](#作用域使用指南)
4. [提交正文规范](#提交正文规范)
5. [分支管理策略](#分支管理策略)
6. [工作流程](#工作流程)
7. [代码审查指南](#代码审查指南)
8. [常见错误示例](#常见错误示例)
9. [工具和自动化](#工具和自动化)

## 提交消息格式

### Conventional Commits 规范
我们采用 [Conventional Commits](https://www.conventionalcommits.org/) 规范，格式如下：

```
<类型>[可选的作用域]: <描述>

[可选的正文]

[可选的脚注]
```

### 格式详解

1. **类型**（必需）：表示提交的性质
2. **作用域**（可选）：表示影响的范围
3. **描述**（必需）：简洁的变更描述
4. **正文**（可选）：详细的变更说明
5. **脚注**（可选）：引用问题或破坏性变更

### 示例
```
feat(server): 添加文件上传功能

- 支持多文件上传
- 添加文件大小限制（最大 10MB）
- 添加文件类型验证（图片、文档）

Closes #123
```

## 提交类型详解

### 核心类型

| 类型 | 描述 | 示例 |
|------|------|------|
| `feat` | 新功能 | `feat(auth): 添加 OAuth2 登录支持` |
| `fix` | 修复 bug | `fix(gtd): 修复任务解析中的空行处理` |
| `docs` | 文档更新 | `docs(readme): 更新安装指南` |
| `style` | 代码格式调整 | `style: 修复代码缩进和空格` |
| `refactor` | 代码重构 | `refactor(server): 重构请求处理逻辑` |
| `test` | 测试相关 | `test(gtd): 添加任务解析单元测试` |
| `chore` | 构建/工具变动 | `chore: 更新依赖版本` |

### 特殊类型

| 类型 | 描述 | 示例 |
|------|------|------|
| `perf` | 性能优化 | `perf(server): 优化文件读取性能` |
| `ci` | CI/CD 配置 | `ci: 添加 GitHub Actions 工作流` |
| `build` | 构建系统 | `build: 更新 webpack 配置` |
| `revert` | 回滚提交 | `revert: 回滚有问题的文件上传功能` |

### 类型选择指南

1. **新功能** → `feat`
2. **修复问题** → `fix`
3. **文档更新** → `docs`
4. **代码美化** → `style`
5. **结构优化** → `refactor`
6. **测试代码** → `test`
7. **维护任务** → `chore`

## 作用域使用指南

### 常用作用域

| 作用域 | 描述 | 示例 |
|--------|------|------|
| `server` | 服务器核心功能 | `feat(server): 添加代理功能` |
| `gtd` | GTD 任务管理 | `fix(gtd): 修复任务状态同步` |
| `auth` | 认证授权 | `feat(auth): 添加 JWT 支持` |
| `api` | API 接口 | `docs(api): 更新 API 文档` |
| `ui` | 用户界面 | `style(ui): 优化响应式布局` |
| `config` | 配置管理 | `refactor(config): 重构配置加载` |
| `test` | 测试相关 | `test: 添加集成测试` |

### 作用域规则

1. **使用小写字母**：`server` 而不是 `Server`
2. **使用连字符分隔单词**：`file-upload` 而不是 `fileUpload`
3. **保持简洁**：不超过 3 个单词
4. **与代码模块对应**：反映实际影响的代码区域

### 何时使用作用域
- 当变更影响特定模块时
- 当需要明确变更范围时
- 当项目有清晰的模块划分时

### 何时省略作用域
- 变更影响多个模块
- 全局性的重构
- 工具链更新

## 提交正文规范

### 正文结构
```
<类型>[作用域]: <描述>

## 变更内容
- 第一项变更
- 第二项变更
- 第三项变更

## 影响范围
- 影响的功能模块
- 需要更新的配置

## 测试说明
- 已添加的测试
- 测试覆盖情况

## 相关链接
- 关联的 Issue
- 参考文档
```

### 正文内容要求

1. **使用中文**：正文使用中文描述
2. **使用列表**：使用 Markdown 列表格式
3. **详细说明**：解释为什么需要这个变更
4. **包含上下文**：提供足够的背景信息
5. **说明影响**：描述对系统的影响

### 示例
```
fix(server): 修复文件路径遍历漏洞

## 变更内容
- 添加路径规范化检查
- 添加目录遍历攻击防护
- 更新文件服务逻辑

## 影响范围
- 所有文件相关操作
- 静态文件服务
- 文件上传功能

## 测试说明
- 添加路径安全测试用例
- 测试恶意路径输入
- 验证防护机制有效性

## 相关链接
- 安全报告 #SEC-2024-001
- OWASP 路径遍历防护指南

Fixes #789
```

## 提交脚注规范

### 常用脚注

| 关键词 | 用途 | 示例 |
|--------|------|------|
| `Closes` | 关闭 Issue | `Closes #123` |
| `Fixes` | 修复问题 | `Fixes #456` |
| `Resolves` | 解决问题 | `Resolves #789` |
| `See also` | 相关参考 | `See also #101` |
| `BREAKING CHANGE` | 破坏性变更 | `BREAKING CHANGE: 修改 API 响应格式` |

### 破坏性变更
当提交包含不兼容的变更时，必须使用 `BREAKING CHANGE` 脚注：

```
feat(api): 重构用户 API 接口

## 变更内容
- 修改用户信息端点路径
- 更新响应数据结构
- 添加新的认证头要求

BREAKING CHANGE: 
- 用户信息端点从 `/api/user` 改为 `/api/v2/user`
- 响应格式从 XML 改为 JSON
- 需要添加 `X-API-Version: 2` 请求头

Closes #234
```

## 分支管理策略

### 分支命名规范

| 分支类型 | 格式 | 示例 |
|----------|------|------|
| 功能分支 | `feature/<功能名>` | `feature/file-upload` |
| 修复分支 | `fix/<问题描述>` | `fix/memory-leak` |
| 文档分支 | `docs/<主题>` | `docs/api-reference` |
| 重构分支 | `refactor/<模块>` | `refactor/auth-module` |
| 测试分支 | `test/<测试内容>` | `test/integration` |
| 发布分支 | `release/<版本>` | `release/v1.2.0` |
| 热修复分支 | `hotfix/<问题>` | `hotfix/security-patch` |

### 分支命名规则

1. **使用小写字母**：`feature/file-upload`
2. **使用连字符分隔**：`fix/memory-leak` 而不是 `fix/memoryLeak`
3. **描述性名称**：清晰表达分支目的
4. **避免特殊字符**：只使用字母、数字和连字符

### 分支生命周期

```
创建分支 → 开发功能 → 提交代码 → 代码审查 → 合并到主分支 → 删除分支
```
